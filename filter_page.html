{% extends 'base.html' %}
{% block title %}{{ product_type }} ìƒí’ˆ í•„í„°ë§{% endblock %}

{% block content %}
<!-- âœ… Select2 ìŠ¤íƒ€ì¼ -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .moa-table th, .moa-table td {
        vertical-align: middle;
        text-align: center;
    }
    .moa-table th {
        background-color: #f8f9fa;
    }
</style>

<div class="container my-5">
    <h1 class="display-5 fw-bold text-center">{{ product_type }} ìƒí’ˆ</h1>

    <!-- ğŸ’° ë‚©ì… ê¸ˆì•¡ ì…ë ¥ -->
    <div class="text-center mb-4">
        <label for="amountInput" class="form-label fw-bold">ì˜ˆì¹˜ê¸ˆ ì…ë ¥ (ì›)</label>
        <input type="number" id="amountInput" class="form-control w-25 d-inline-block" value="1000000" step="10000" min="0">
    </div>

    <!-- âŒ› ê°€ì…ê¸°ê°„ -->
    {% if product_type != 'ëŒ€ì¶œ' %}
    <div class="mb-3 text-center">
        <button class="btn btn-outline-dark active" data-period="">ì „ì²´</button>
        {% for p in periods %}
        <button class="btn btn-outline-dark" data-period="{{ p }}">{{ p }}ê°œì›”</button>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ğŸ¦ ê¸ˆìœµê¶Œ ì„ íƒ -->
    <div class="mb-3 text-center">
        <button class="btn btn-outline-primary active" data-group="ì „ì²´" onclick="setBankGroup('ì „ì²´')">ì „ì²´</button>
        <button class="btn btn-outline-primary" data-group="1ê¸ˆìœµê¶Œ" onclick="setBankGroup('1ê¸ˆìœµê¶Œ')">1ê¸ˆìœµê¶Œ</button>
        <button class="btn btn-outline-primary" data-group="2ê¸ˆìœµê¶Œ" onclick="setBankGroup('2ê¸ˆìœµê¶Œ')">2ê¸ˆìœµê¶Œ</button>
    </div>

    <!-- ğŸ” ì€í–‰ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
    <div class="mb-3 text-center">
        <select id="bankSelect" class="form-select w-50 d-inline-block" multiple></select>
    </div>

    <!-- ğŸ—ºï¸ ì§€ì—­ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
    <div class="mb-3 text-center">
        <select id="regionSelect" class="form-select w-50 d-inline-block">
            <option value="">ì „ì²´ ì§€ì—­</option>
            {% for region in regions %}
            <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- ğŸ” ê²€ìƒ‰ ë²„íŠ¼ -->
    <div class="text-center mb-4">
        <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
    </div>

    <!-- ğŸ“Š ìƒí’ˆ í…Œì´ë¸” -->
    <div class="table-responsive">
        <table class="table table-bordered moa-table">
            <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ê¸ˆìœµíšŒì‚¬ëª…</th>
                    <th>ìƒí’ˆëª…</th>
                    <th>ì„¸ì „ê¸ˆë¦¬</th>
                    <th>ì„¸í›„ìˆ˜ë ¹ì•¡</th>
                    <th>ìì„¸íˆ ë³´ê¸°</th>
                </tr>
            </thead>
            <tbody id="product-tbody"></tbody>
        </table>
    </div>
</div>

<!-- âœ… Select2 ë° jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    let selectedPeriod = "";
    let selectedBanks = [];
    let selectedRegion = "";
    let selectedBankGroup = 'ì „ì²´';
    const allBanks = {{ banks | tojson }};

    function calculateAfterTax(amount, rate, months = 12) {
        let grossInterest = amount * (rate / 100) * (months / 12);
        let tax = grossInterest * 0.154;
        let afterTax = amount + (grossInterest - tax);
        return Math.round(afterTax).toLocaleString('ko-KR') + 'ì›';
    }

    function loadProducts() {
        // ì€í–‰ ê·¸ë£¹ í•„í„°ë§: ê°œë³„ ì„ íƒ ìš°ì„ , ì„ íƒ ì—†ìœ¼ë©´ ê·¸ë£¹ ì „ì²´
let bankListParam = selectedBanks.length > 0 ? selectedBanks : (selectedBankGroup !== 'ì „ì²´' ? allBanks[selectedBankGroup] : []);
const banksParam = bankListParam.length > 0 ? bankListParam.join('|') : '';
        const amount = parseFloat(document.getElementById('amountInput').value) || 0;
        let query = `bank=${encodeURIComponent(banksParam)}`;
        if (selectedPeriod) query += `&period=${selectedPeriod}`;
        if (selectedRegion) query += `&region=${encodeURIComponent(selectedRegion)}`;
        query += `&amount=${amount}`;

        fetch(`/api/{{ product_type_url }}?${query}`)
            .then(response => response.json())
            .then(result => {
                const tbody = document.getElementById('product-tbody');
                tbody.innerHTML = '';
                if (result.products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">ì¡°ê±´ì— ë§ëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                result.products.forEach((p, idx) => {
                    const rate = parseFloat(p['ìµœê³ ìš°ëŒ€ê¸ˆë¦¬(%)']) || 0;
                    const months = parseInt(p['ì €ì¶•ê¸°ê°„(ê°œì›”)']) || 12;
                    const afterTax = calculateAfterTax(amount, rate, months);
                    const encoded = encodeURIComponent(p['ìƒí’ˆëª…']);

                    tbody.innerHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${p['ê¸ˆìœµíšŒì‚¬ëª…']}</td>
                            <td>${p['ìƒí’ˆëª…']}</td>
                            <td>${rate.toFixed(2)}%</td>
                            <td>${afterTax}</td>
                            <td><a href="/{{ product_type_url }}/detail/${encoded}" class="btn btn-sm btn-primary">ìì„¸íˆ ë³´ê¸°</a></td>
                        </tr>`;
                });
            });
    }

    function setBankGroup(group) {
        selectedBankGroup = group;
        selectedBanks = [];
        renderBankDropdown();

        document.querySelectorAll('[data-group]').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-group="${group}"]`).classList.add('active');
    }

    function renderBankDropdown() {
        const $select = $('#bankSelect');
        $select.empty();

        let bankList = [];
        if (selectedBankGroup === 'ì „ì²´') {
            bankList = [...new Set([...allBanks['1ê¸ˆìœµê¶Œ'], ...allBanks['2ê¸ˆìœµê¶Œ']])];
        } else {
            bankList = allBanks[selectedBankGroup] || [];
        }

        bankList.forEach(bank => {
            $select.append(new Option(bank, bank));
        });

        $select.val(null).trigger('change');
    }

    $(document).ready(function () {
        $('#bankSelect').select2({
            placeholder: "ì€í–‰ì„ ì„ íƒí•˜ì„¸ìš”",
            allowClear: true,
            width: 'resolve',
            multiple: true
        });

        $('#bankSelect').on('change', function () {
            selectedBanks = $(this).val() || [];
        });

        $('#regionSelect').on('change', function () {
            selectedRegion = this.value;
        });

        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.addEventListener('click', function () {
                selectedPeriod = this.dataset.period;
                document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.getElementById('searchBtn').addEventListener('click', loadProducts);

        // ì´ˆê¸° ë“œë¡­ë‹¤ìš´ ì„¤ì •
        setBankGroup('ì „ì²´');
    });
</script>
{% endblock %}
